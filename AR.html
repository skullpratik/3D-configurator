<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three.js AR + QR (Single File, Draco)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: system-ui, Arial, sans-serif; }
    #ui { position:absolute; top:12px; left:12px; z-index:10; }
    .btn {
      padding:10px 14px; border:none; border-radius:10px; background:#1e90ff; color:#fff;
      font-weight:600; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    #snapshotBtn {
      display:none; position:absolute; right:16px; bottom:16px; z-index:10;
      padding:10px 14px; border:none; border-radius:10px; background:#111; color:#fff; cursor:pointer;
    }
    #qrModal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.7);
      z-index:20; align-items:center; justify-content:center; flex-direction:column; gap:12px;
    }
    #qrCard { background:#fff; padding:16px; border-radius:12px; text-align:center; max-width: 320px; }
    #qrCard canvas, #qrCard img { display:block; margin:0 auto; }
    #closeQr { margin-top:10px; background:#e53935; }
  </style>

  <!-- Three.js (use same r128 across all scripts) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/ARButton.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div id="ui">
    <button id="arButton" class="btn">ðŸ‘“ View in AR</button>
  </div>

  <button id="snapshotBtn">ðŸ“¸ Snapshot</button>

  <!-- QR Modal -->
  <div id="qrModal">
    <div id="qrCard">
      <div id="qrCanvas"></div>
      <div style="font-size:12px; color:#333; margin-top:6px;">Scan on your phone to open AR</div>
      <button id="closeQr" class="btn">Close</button>
    </div>
  </div>

  <script>
    // ---------- Config ----------
    const MODEL_URL = '/models/Visicooler.glb'; // change if your path is different
    const USE_QR_ON_DESKTOP = true;             // show QR on desktop

    // ---------- Three.js / AR state ----------
    let scene, camera, renderer;
    let model = null;
    let reticle;
    let controller;

    let hitTestSource = null;
    let localSpace = null;

    const snapshotBtn = document.getElementById('snapshotBtn');

    // ---------- Init ----------
    init();
    animate();

    function init() {
      // Scene & Camera
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lighting
      const hemi = new THREE.HemisphereLight(0xffffff, 0x8888ff, 1.0);
      hemi.position.set(0, 1, 0);
      scene.add(hemi);

      const dir = new THREE.DirectionalLight(0xffffff, 0.6);
      dir.position.set(1, 2, 1);
      scene.add(dir);

      // Reticle
      const ring = new THREE.RingGeometry(0.07, 0.09, 32).rotateX(-Math.PI / 2);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ff7f });
      reticle = new THREE.Mesh(ring, ringMat);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // Controller (tap to place)
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      // Load model (hidden until placed) + DRACO support
      const loader = new THREE.GLTFLoader();
      const dracoLoader = new THREE.DRACOLoader();
      // Use Google's hosted Draco decoders (works over HTTPS/localhost)
      dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
      loader.setDRACOLoader(dracoLoader);

      loader.load(
        MODEL_URL,
        (gltf) => {
          model = gltf.scene;
          model.visible = false;           // becomes visible when placed
          model.traverse((o) => { if (o.isMesh) { o.castShadow = false; o.receiveShadow = false; }});
          model.scale.set(1, 1, 1);        // adjust if your model is huge/small
          scene.add(model);
        },
        (xhr) => {
          // Optional: console.log(`Loading model: ${(xhr.loaded / xhr.total * 100).toFixed(0)}%`);
        },
        (err) => console.error('Failed to load model:', err)
      );

      // AR button / QR handling
      setupARButtonAndQR();

      // Resize handling
      window.addEventListener('resize', onWindowResize);

      // Session events for hit-test & UI
      renderer.xr.addEventListener('sessionstart', onSessionStart);
      renderer.xr.addEventListener('sessionend', onSessionEnd);

      // Snapshot
      snapshotBtn.addEventListener('click', doSnapshot);
    }

    function setupARButtonAndQR() {
      const arBtn = document.getElementById('arButton');
      const qrModal = document.getElementById('qrModal');
      const closeQr = document.getElementById('closeQr');

      const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

      if (navigator.xr && isMobile) {
        // WebXR available on mobile â†’ inject ARButton
        const btn = THREE.ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
        // Style tweak for consistency
        btn.style.padding = '10px 14px';
        btn.style.borderRadius = '10px';
        btn.style.background = '#1e90ff';
        btn.style.color = '#fff';
        btn.style.fontWeight = '600';
        btn.style.boxShadow = '0 2px 8px rgba(0,0,0,.2)';
        arBtn.replaceWith(btn);
      } else if (USE_QR_ON_DESKTOP) {
        // Desktop â†’ show QR modal
        arBtn.addEventListener('click', openQrModal);
        closeQr.addEventListener('click', () => { qrModal.style.display = 'none'; });
      } else {
        arBtn.addEventListener('click', () => alert('Open this page on a WebXR-capable mobile browser (HTTPS).'));
      }
    }

    function openQrModal() {
      const qrModal = document.getElementById('qrModal');
      const qrCanvas = document.getElementById('qrCanvas');
      qrModal.style.display = 'flex';
      // Clear previous QR render
      qrCanvas.innerHTML = '';
      QRCode.toCanvas(window.location.href, { width: 220 }, (err, canvas) => {
        if (!err) qrCanvas.appendChild(canvas);
      });
    }

    // Place model where the reticle is
    function onSelect() {
      if (model && reticle.visible) {
        const m = new THREE.Matrix4();
        m.copy(reticle.matrix);

        const pos = new THREE.Vector3();
        const quat = new THREE.Quaternion();
        const scale = new THREE.Vector3();
        m.decompose(pos, quat, scale);

        model.position.copy(pos);
        model.quaternion.copy(quat);
        model.visible = true;
      }
    }

    async function onSessionStart() {
      const session = renderer.xr.getSession();
      try {
        const viewerSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
        localSpace = await session.requestReferenceSpace('local');
      } catch (e) {
        console.error('Hit test setup failed:', e);
      }
      snapshotBtn.style.display = 'inline-block';
    }

    function onSessionEnd() {
      hitTestSource = null;
      localSpace = null;
      reticle.visible = false;
      snapshotBtn.style.display = 'none';
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(time, frame) {
      // Update reticle from hit-test
      if (frame && hitTestSource && localSpace) {
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length > 0) {
          const hit = hits[0];
          const pose = hit.getPose(localSpace);
          if (pose) {
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        } else {
          reticle.visible = false;
        }
      }
      renderer.render(scene, camera);
    }

    function doSnapshot() {
      renderer.domElement.toBlob((blob) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ar_snapshot.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }
  </script>
</body>
</html>
