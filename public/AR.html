<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View in AR (Single File, No Loop)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: system-ui, Arial, sans-serif; background:#000; color:#fff; }
    #ui { position:absolute; top:12px; left:12px; z-index:10; display:flex; gap:8px; align-items:center; }
    .btn { padding:10px 14px; border:none; border-radius:10px; background:#1e90ff; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.35); }
    #qrModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:20; align-items:center; justify-content:center; flex-direction:column; gap:12px; }
    #qrCard { background:#fff; color:#000; padding:16px; border-radius:12px; text-align:center; max-width: 320px; }
    #qrCard canvas { display:block; margin:0 auto; }
    #closeQr { margin-top:10px; background:#e53935; }
    /* Optional preview canvas area (black background) */
    #preview { width:100vw; height:100vh; display:block; background:#000; }
    .note { font-size:12px; opacity:.8; }
  </style>

  <!-- (Optional) Tiny preview using Three.js â€” you can remove these 3 if you don't want preview -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>

  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div id="ui">
    <button id="openArBtn" class="btn">ðŸ‘“ View in AR</button>
    <button id="qrBtn" class="btn">ðŸ”— Get Phone Link</button>
    <span class="note" id="statusNote"></span>
  </div>

  <!-- Optional preview canvas -->
  <canvas id="preview"></canvas>

  <!-- QR Modal -->
  <div id="qrModal">
    <div id="qrCard">
      <div id="qrCanvas"></div>
      <div style="font-size:12px; color:#333; margin-top:6px;">Scan on your phone to open AR</div>
      <button id="closeQr" class="btn">Close</button>
    </div>
  </div>

  <script>
    // ---------------- Config ----------------
    const MODEL_GLB = '/models/Visicooler.glb';   // Android / Scene Viewer
    const MODEL_USDZ = '/models/Visicooler.usdz'; // iOS / Quick Look (must exist for iPhone)
    const REQUIRE_IOS_USDZ = true; // if true and USDZ missing, we warn iOS users

    // Build absolute URLs (Netlify needs HTTPS absolute for intents)
    const ABS_GLB  = new URL(MODEL_GLB,  window.location.origin).toString();
    const ABS_USDZ = new URL(MODEL_USDZ, window.location.origin).toString();

    // ---------------- Platform helpers ----------------
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);

    // ---------------- AR openers ----------------
    function openAndroidSceneViewer() {
      // Scene Viewer intent with fallback to https
      const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(ABS_GLB)}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
      window.location.href = intent;
    }

    function openIOSQuickLook() {
      if (REQUIRE_IOS_USDZ && !ABS_USDZ.endsWith('.usdz')) {
        alert('iOS AR requires a .usdz model. Please provide /models/Visicooler.usdz');
        return;
      }
      // Quick Look just needs an <a rel="ar"> or direct navigation to the usdz
      window.location.href = ABS_USDZ;
    }

    function openARForThisDevice() {
      if (isAndroid) {
        openAndroidSceneViewer();
      } else if (isIOS) {
        openIOSQuickLook();
      } else {
        // Desktop or unsupported mobile -> show QR that auto-opens AR on phone
        openQrModal(true); // true => encode ?openAR=1 link
      }
    }

    // When page is opened with ?openAR=1 on a phone, auto-launch AR
    (function autoOpenFromQR() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('openAR') === '1') {
        // Small delay to allow Safari/Chrome to settle
        setTimeout(() => openARForThisDevice(), 250);
      }
    })();

    // ---------------- UI wiring ----------------
    document.getElementById('openArBtn').addEventListener('click', openARForThisDevice);
    document.getElementById('qrBtn').addEventListener('click', () => openQrModal(true));
    document.getElementById('closeQr').addEventListener('click', () => {
      document.getElementById('qrModal').style.display = 'none';
    });

    function openQrModal(encodeAutoOpen) {
      const qrModal = document.getElementById('qrModal');
      const qrCanvasWrap = document.getElementById('qrCanvas');
      qrCanvasWrap.innerHTML = '';
      qrModal.style.display = 'flex';

      // Build a page URL that includes ?openAR=1 so mobile auto-opens AR and avoids loops
      let url = window.location.origin + window.location.pathname;
      if (encodeAutoOpen) {
        const u = new URL(url);
        u.searchParams.set('openAR', '1');
        url = u.toString();
      }

      QRCode.toCanvas(url, { width: 240 }, (err, canvas) => {
        if (!err) qrCanvasWrap.appendChild(canvas);
      });
    }

    // ---------------- Optional tiny preview (not AR) ----------------
    // Remove this block if you don't want a 3D preview behind the UI.
    (function previewInit(){
      try {
        const canvas = document.getElementById('preview');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 3);

        const geo = new THREE.BoxGeometry(1,1,1);
        const mat = new THREE.MeshStandardMaterial({ color: 0x1e90ff, roughness: 0.6, metalness: 0.1 });
        const cube = new THREE.Mesh(geo, mat);
        scene.add(cube);

        const light1 = new THREE.HemisphereLight(0xffffff, 0x222233, 1.2); scene.add(light1);
        const light2 = new THREE.DirectionalLight(0xffffff, 0.8); light2.position.set(2,3,2); scene.add(light2);

        function tick(){
          cube.rotation.y += 0.01;
          cube.rotation.x += 0.005;
          renderer.render(scene, camera);
          requestAnimationFrame(tick);
        }
        tick();

        window.addEventListener('resize', () => {
          renderer.setSize(window.innerWidth, window.innerHeight);
          camera.aspect = window.innerWidth/window.innerHeight;
          camera.updateProjectionMatrix();
        });

        // Status hint
        document.getElementById('statusNote').textContent =
          isAndroid ? 'Android detected: Scene Viewer will open.' :
          isIOS ? 'iOS detected: Quick Look will open.' :
          'Desktop: use QR to open on phone.';
      } catch(e) {
        // If WebGL not available, still keep AR buttons working
        document.getElementById('statusNote').textContent = 'Use the buttons above to open AR.';
      }
    })();
  </script>
</body>
</html>
